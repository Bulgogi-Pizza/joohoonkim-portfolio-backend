name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          echo "ENV=prod" >> $GITHUB_ENV
          echo "EC2_HOST=13.209.8.80" >> $GITHUB_ENV
          echo "FRONTEND_ORIGIN=https://main.d1jx5u7u0ebuxt.amplifyapp.com,https://dev.d1jx5u7u0ebuxt.amplifyapp.com" >> $GITHUB_ENV
          echo "BACKEND_DOMAIN=api.joohoonkim.site" >> $GITHUB_ENV

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_PROD_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 13.209.8.80 >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ec2-user@${{ env.EC2_HOST }} << 'EOF'
            # ë°°í¬ ë””ë ‰í† ë¦¬ ì„¤ì •
            DEPLOY_DIR="/home/ec2-user/portfolio-backend"
            
            # ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p $DEPLOY_DIR
            cd $DEPLOY_DIR
            
            # Git ì €ìž¥ì†Œ ì´ˆê¸°í™” ë˜ëŠ” ì—…ë°ì´íŠ¸
            if [ ! -d ".git" ]; then
              git clone https://github.com/${{ github.repository }}.git .
            fi
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git fetch --all
            git reset --hard origin/${{ github.ref_name }}
            
            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
            cat > .env << 'ENVEOF'
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          CERTBOT_EMAIL=${{ secrets.CERTBOT_EMAIL }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD_HASH=${{ secrets.ADMIN_PASSWORD_HASH }}
          FRONTEND_ORIGIN=${{ env.FRONTEND_ORIGIN }}
          AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          ENVEOF
            
            # Nginx ì„¤ì •
            sudo tee /etc/nginx/conf.d/portfolio-backend.conf > /dev/null << 'NGINXEOF'
          server {
              listen 80;
              server_name ${{ env.BACKEND_DOMAIN }};

              location / {
                  proxy_pass http://localhost:8000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }

              location /static {
                  proxy_pass http://localhost:8000/static;
              }
          }
          NGINXEOF
            
            # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ìž¬ì‹œìž‘
            sudo nginx -t && sudo systemctl restart nginx
            
            # Docker Composeë¡œ ë°°í¬
            echo "ðŸ“¦ Stopping existing containers..."
            docker-compose down || true
            
            echo "ðŸ”¨ Building Docker image..."
            # ë ˆê±°ì‹œ ë¹Œë” ì‚¬ìš© (buildx ë²„ì „ ë¬¸ì œ í•´ê²°)
            DOCKER_BUILDKIT=0 docker-compose build --no-cache
            
            echo "ðŸš€ Starting containers..."
            docker-compose up -d
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ðŸ“Š Container status:"
            docker-compose ps
            docker ps -a
            
            # ë¡œê·¸ í™•ì¸
            echo "ðŸ“ Container logs:"
            docker-compose logs --tail=50
            
            # ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
            echo "â³ Waiting for container to be healthy..."
            sleep 10
            
            # ë¡œì»¬ API í…ŒìŠ¤íŠ¸
            echo "ðŸ” Testing local API..."
            curl -f http://localhost:8000/health || echo "âš ï¸  API not responding yet"
            
            # SSL ì¸ì¦ì„œ ì„¤ì • (ì²˜ìŒ í•œ ë²ˆë§Œ ì‹¤í–‰ë¨)
            if [ ! -f "/etc/letsencrypt/live/${{ env.BACKEND_DOMAIN }}/fullchain.pem" ]; then
              echo "ðŸ” SSL ì¸ì¦ì„œ ë°œê¸‰ ì¤‘..."
              echo "â³ Waiting for Nginx to be ready..."
              sleep 5
              sudo certbot --nginx -d ${{ env.BACKEND_DOMAIN }} --non-interactive --agree-tos -m ${{ secrets.CERTBOT_EMAIL }} || echo "âš ï¸  SSL ì¸ì¦ì„œ ë°œê¸‰ ì‹¤íŒ¨ - ë‚˜ì¤‘ì— ìˆ˜ë™ìœ¼ë¡œ ë°œê¸‰í•˜ì„¸ìš”"
            else
              echo "âœ… SSL ì¸ì¦ì„œê°€ ì´ë¯¸ ì¡´ìž¬í•©ë‹ˆë‹¤"
            fi
            
            # ì˜¤ëž˜ëœ ì´ë¯¸ì§€ ì •ë¦¬
            docker system prune -f
            
            echo "âœ… Deployment completed!"
            echo "ðŸŒ Backend URL: https://${{ env.BACKEND_DOMAIN }}"
          EOF

      - name: Verify deployment
        run: |
          echo "ðŸŽ‰ Deployment completed!"
          echo "Environment: Production"
          echo "EC2 Host: ${{ env.EC2_HOST }}"
          echo "Backend URL: https://${{ env.BACKEND_DOMAIN }}"
          echo "Frontend Origins: ${{ env.FRONTEND_ORIGIN }}"

